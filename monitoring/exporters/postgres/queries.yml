# Custom PostgreSQL queries for OptiInfra metrics
# Used by postgres_exporter

# Agent statistics
pg_agent_stats:
  query: |
    SELECT 
      agent_type,
      COUNT(*) as agent_count,
      COUNT(*) FILTER (WHERE status = 'active') as active_count,
      COUNT(*) FILTER (WHERE status = 'inactive') as inactive_count
    FROM agents
    GROUP BY agent_type
  metrics:
    - agent_type:
        usage: "LABEL"
        description: "Type of agent"
    - agent_count:
        usage: "GAUGE"
        description: "Total number of agents"
    - active_count:
        usage: "GAUGE"
        description: "Number of active agents"
    - inactive_count:
        usage: "GAUGE"
        description: "Number of inactive agents"

# Task statistics
pg_task_stats:
  query: |
    SELECT 
      task_type,
      status,
      COUNT(*) as task_count
    FROM tasks
    WHERE created_at > NOW() - INTERVAL '1 hour'
    GROUP BY task_type, status
  metrics:
    - task_type:
        usage: "LABEL"
        description: "Type of task"
    - status:
        usage: "LABEL"
        description: "Task status"
    - task_count:
        usage: "GAUGE"
        description: "Number of tasks in last hour"

# Optimization statistics
pg_optimization_stats:
  query: |
    SELECT 
      optimization_type,
      COUNT(*) as total_count,
      COUNT(*) FILTER (WHERE status = 'completed') as completed_count,
      COUNT(*) FILTER (WHERE status = 'failed') as failed_count,
      AVG(EXTRACT(EPOCH FROM (completed_at - started_at))) as avg_duration_seconds
    FROM optimizations
    WHERE created_at > NOW() - INTERVAL '24 hours'
    GROUP BY optimization_type
  metrics:
    - optimization_type:
        usage: "LABEL"
        description: "Type of optimization"
    - total_count:
        usage: "GAUGE"
        description: "Total optimizations in last 24h"
    - completed_count:
        usage: "GAUGE"
        description: "Completed optimizations"
    - failed_count:
        usage: "GAUGE"
        description: "Failed optimizations"
    - avg_duration_seconds:
        usage: "GAUGE"
        description: "Average optimization duration"

# Cost savings statistics
pg_cost_savings:
  query: |
    SELECT 
      provider,
      SUM(estimated_savings) as total_savings,
      COUNT(*) as recommendation_count
    FROM cost_recommendations
    WHERE created_at > NOW() - INTERVAL '24 hours'
    GROUP BY provider
  metrics:
    - provider:
        usage: "LABEL"
        description: "Cloud provider"
    - total_savings:
        usage: "GAUGE"
        description: "Total estimated savings (USD)"
    - recommendation_count:
        usage: "GAUGE"
        description: "Number of recommendations"

# Workflow history
pg_workflow_stats:
  query: |
    SELECT 
      workflow_type,
      status,
      COUNT(*) as workflow_count
    FROM workflow_history
    WHERE created_at > NOW() - INTERVAL '1 hour'
    GROUP BY workflow_type, status
  metrics:
    - workflow_type:
        usage: "LABEL"
        description: "Type of workflow"
    - status:
        usage: "LABEL"
        description: "Workflow status"
    - workflow_count:
        usage: "GAUGE"
        description: "Number of workflows"

# Database size metrics
pg_database_size:
  query: |
    SELECT 
      pg_database_size('optiinfra') as database_size_bytes,
      (SELECT COUNT(*) FROM agents) as total_agents,
      (SELECT COUNT(*) FROM tasks) as total_tasks,
      (SELECT COUNT(*) FROM optimizations) as total_optimizations
  metrics:
    - database_size_bytes:
        usage: "GAUGE"
        description: "Total database size in bytes"
    - total_agents:
        usage: "GAUGE"
        description: "Total number of agents"
    - total_tasks:
        usage: "GAUGE"
        description: "Total number of tasks"
    - total_optimizations:
        usage: "GAUGE"
        description: "Total number of optimizations"
